#!/usr/bin/env bash
set -Eeuo pipefail

CMD=${1:-}

case "$CMD" in
  start)
    DB_PATH="var/search.sqlite3"

    if [ ! -f "$DB_PATH" ]; then
      echo "Error: search database $DB_PATH does not exist"
      echo "Try: ./bin/searchdb"
      exit 1
    fi

    # Check index server status (must be running)
    if ! ./bin/index status > /dev/null 2>&1; then
      echo "Error: index server is not running"
      echo "Try ./bin/index start"
      exit 1
    fi

    # Check if search already running
    if pgrep -f 'flask --app search run --host 0.0.0.0 --port 8000' > /dev/null; then
      echo "Error: search server is already running"
      exit 1
    fi

    echo "starting search server ..."
    mkdir -p var/log
    rm -f var/log/search.log
    flask --app search run --host 0.0.0.0 --port 8000 &> var/log/search.log &
    ;;

  stop)
    echo "stopping search server ..."
    pkill -f 'flask --app search run --host 0.0.0.0 --port 8000' || true
    ;;

  restart)
    echo "stopping search server ..."
    pkill -f 'flask --app search run --host 0.0.0.0 --port 8000' || true
    echo "starting search server ..."
    mkdir -p var/log
    rm -f var/log/search.log
    flask --app search run --host 0.0.0.0 --port 8000 &> var/log/search.log &
    ;;

  status)
    # same pattern as spec, but for search
    set +o pipefail
    NPROCS=$(pgrep -f 'flask --app search run --host 0.0.0.0 --port 8000' | wc -l)
    set -o pipefail

    if [ "$NPROCS" -eq 1 ]; then
      echo "search server running"
      exit 0
    elif [ "$NPROCS" -eq 0 ]; then
      echo "search server stopped"
      exit 1
    else
      echo "search server error: found ${NPROCS} processes, expected 1"
      exit 2
    fi
    ;;

  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac
