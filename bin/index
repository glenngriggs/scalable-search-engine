#!/usr/bin/env bash
# Control script for the Index servers: start | stop | restart | status

# Safer bash defaults:
# -e : exit on error
# -E : inherit ERR traps
# -u : treat unset variables as errors
# -o pipefail : catch errors in piped commands
set -Eeuo pipefail

CMD="${1-}"               # first argument: start/stop/restart/status
LOG_DIR="var/log"
LOG_FILE="${LOG_DIR}/index.log"

start_servers() {
  echo "starting index server ..."
  mkdir -p "${LOG_DIR}"
  rm -f "${LOG_FILE}"

  # Segment 0 → port 9000
  INDEX_PATH="index_server/index/inverted_index/inverted_index_0.txt" \
    flask --app index run --host 0.0.0.0 --port 9000 >> "${LOG_FILE}" 2>&1 &

  # Segment 1 → port 9001
  INDEX_PATH="index_server/index/inverted_index/inverted_index_1.txt" \
    flask --app index run --host 0.0.0.0 --port 9001 >> "${LOG_FILE}" 2>&1 &

  # Segment 2 → port 9002
  INDEX_PATH="index_server/index/inverted_index/inverted_index_2.txt" \
    flask --app index run --host 0.0.0.0 --port 9002 >> "${LOG_FILE}" 2>&1 &
}

stop_servers() {
  echo "stopping index server ..."
  # Kill each of the three index-server Flask processes if running.
  pkill -f "flask --app index run --host 0.0.0.0 --port 9000" || true
  pkill -f "flask --app index run --host 0.0.0.0 --port 9001" || true
  pkill -f "flask --app index run --host 0.0.0.0 --port 9002" || true
}

status_servers() {
  # This snippet is straight from the spec
  set +o pipefail
  NPROCS=$(pgrep -f "flask --app index run --host 0.0.0.0 --port 900[0-2]" | wc -l || true)
  set -o pipefail

  if [ "$NPROCS" -eq 3 ]; then
    echo "index server running"
    exit 0
  elif [ "$NPROCS" -eq 0 ]; then
    echo "index server stopped"
    exit 1
  else
    echo "index server error: found ${NPROCS} processes, expected 3"
    exit 2
  fi
}

case "${CMD}" in
  start)
    # Don't start if already running
    if ./bin/index status >/dev/null 2>&1; then
      echo "Error: index server is already running"
      exit 1
    fi
    start_servers
    ;;
  stop)
    stop_servers
    ;;
  restart)
    stop_servers
    start_servers
    ;;
  status)
    status_servers
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac
